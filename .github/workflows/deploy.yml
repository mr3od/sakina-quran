name: Deploy Sakina Quran

on:
  push:
    branches:
      - main
      - development

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          BRANCH="${{ github.ref_name }}"
          if [ "$BRANCH" = "main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "deployment=sakina-deployment" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Deploying to PRODUCTION"
          else
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "deployment=sakina-deployment-dev" >> $GITHUB_OUTPUT
            echo "ðŸš§ Deploying to DEVELOPMENT"
          fi

      # --- Build & Push Steps ---

      - name: Allow insecure registry
        run: |
          echo '{ "insecure-registries": ["${{ secrets.REGISTRY_URL }}"] }' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker

      - name: Log in to Docker Registry
        run: echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ${{ secrets.REGISTRY_URL }} -u ${{ secrets.REGISTRY_USER }} --password-stdin

      - name: Build and Push Docker image
        run: |
          ENV="${{ steps.env.outputs.environment }}"
          
          # Build using the Expo Dockerfile
          docker build -t sakina-quran:$ENV .

          # Tag for your private registry
          docker tag sakina-quran:$ENV ${{ secrets.REGISTRY_URL }}/abdulrahman/sakina-quran:$ENV
          docker tag sakina-quran:$ENV ${{ secrets.REGISTRY_URL }}/abdulrahman/sakina-quran:latest

          # Push to registry
          docker push ${{ secrets.REGISTRY_URL }}/abdulrahman/sakina-quran:$ENV
          docker push ${{ secrets.REGISTRY_URL }}/abdulrahman/sakina-quran:latest

      # --- Deploy to VPS (MicroK8s) ---

      - name: Set up SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

      - name: Restart Deployment on VPS
        run: |
          DEPLOYMENT="${{ steps.env.outputs.deployment }}"
          ENV="${{ steps.env.outputs.environment }}"
          
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} << EOF
          echo "ðŸ”„ Restarting $DEPLOYMENT ($ENV environment)..."
          microk8s kubectl rollout restart deployment $DEPLOYMENT
          echo "âœ… Deployment restarted successfully"
          EOF

      - name: Deployment summary
        run: |
          ENV="${{ steps.env.outputs.environment }}"
          BRANCH="${{ github.ref_name }}"
          
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: $BRANCH" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $ENV" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment**: ${{ steps.env.outputs.deployment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Image built, pushed, and deployment restarted successfully." >> $GITHUB_STEP_SUMMARY
